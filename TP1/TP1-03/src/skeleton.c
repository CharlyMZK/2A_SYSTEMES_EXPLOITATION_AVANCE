/**
 * \file skeleton.c
 * \brief Basic parsing options skeleton.
 * \author Pierre L. <pierre1.leroy@orange.com>
 * \version 0.1
 * \date 10 septembre 2016
 *
 * Basic parsing options skeleton exemple c file.
 */
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include <pwd.h>
#include <grp.h>
#include<errno.h>
#include <fcntl.h> // for open
#include <unistd.h> // for close
#include<getopt.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <time.h>
#include <dirent.h> 
#define STDOUT 1
#define STDERR 2

#define MAX_PATH_LENGTH 4096


#define USAGE_SYNTAX "[OPTIONS] -i INPUT -o OUTPUT"
#define USAGE_PARAMS "OPTIONS:\n\
  -i, --input  INPUT_FILE  : input file\n\
  -o, --output OUTPUT_FILE : output file\n\
***\n\
  -v, --verbose : enable *verbose* mode\n\
  -h, --help    : display this help\n\
"

/**
 * Procedure which displays binary usage
 * by printing on stdout all available options
 *
 * \return void
 */
void print_usage(char* bin_name)
{
  dprintf(1, "USAGE: %s %s\n\n%s\n", bin_name, USAGE_SYNTAX, USAGE_PARAMS);
}


/**
 * Procedure checks if variable must be free
 * (check: ptr != NULL)
 *
 * \param void* to_free pointer to an allocated mem
 * \see man 3 free
 * \return void
 */
void free_if_needed(void* to_free)
{
  if (to_free != NULL) free(to_free);  
}


/**
 *
 * \see man 3 strndup
 * \see man 3 perror
 * \return
 */
char* dup_optarg_str()
{
  char* str = NULL;

  if (optarg != NULL)
  {
    str = strndup(optarg, MAX_PATH_LENGTH);
    
    // Checking if ERRNO is set
    if (str == NULL) 
      perror(strerror(errno));
  }

  return str;
}

/**
 * Binary options string
 * (linked to optionn declaration)
 *
 * \see man 3 getopt_long or getopt
 */ 
const char* binary_optstr = "hvi:o:";

void checkIfFilesExists(int sourceFile, int destFile){
   if(sourceFile < 0 || destFile < 0){
       dprintf(1,"\nException occured : ");
       perror(strerror(errno));
       exit(0);
   }
}

void displayFileRights(struct stat fileStat){
    printf("| ");
    printf( (S_ISDIR(fileStat.st_mode)) ? "d" : "-");
    printf( (fileStat.st_mode & S_IRUSR) ? "r" : "-");
    printf( (fileStat.st_mode & S_IWUSR) ? "w" : "-");
    printf( (fileStat.st_mode & S_IXUSR) ? "x" : "-");
    printf( (fileStat.st_mode & S_IRGRP) ? "r" : "-");
    printf( (fileStat.st_mode & S_IWGRP) ? "w" : "-");
    printf( (fileStat.st_mode & S_IXGRP) ? "x" : "-");
    printf( (fileStat.st_mode & S_IROTH) ? "r" : "-");
    printf( (fileStat.st_mode & S_IWOTH) ? "w" : "-");
    printf( (fileStat.st_mode & S_IXOTH) ? "x" : "-");
}

void displayFileHolder(struct stat fileStat){
  struct passwd *pw = getpwuid(fileStat.st_uid);
  if(pw != 0){
    printf(" | %s:",pw->pw_name);
  }
}

void displayFileName(struct dirent* fichierLu){
 printf("%s", fichierLu->d_name);
}

void displayFileSize(struct stat fileStat){
  printf(" -%lld- ", (long long) fileStat.st_size);
}

void displayFileLastModifiedDate(struct stat fileStat){
 //printf(" @ %s \n", ctime(&fileStat.st_mtime));
  char date[10];
  char hour[10];
  strftime(hour, 10, "%Hh%M", gmtime(&(fileStat.st_ctime)));
  strftime(date, 10, "%d%m%y", gmtime(&(fileStat.st_ctime)));
  printf(" %s @ %s \n",date, hour);
    
}

void displayFileGroup(struct stat fileStat){
  struct group  *gr = getgrgid(fileStat.st_gid);
  if (gr != 0){
    printf("%s",gr->gr_name);
  }
}

/**
 * Binary main loop
 *
 * \return 1 if it exit successfully 
 */
int main(int argc, char** argv)
{
  /**
   * Binary variables
   * (could be defined in a structure)
   */
  DIR* rep = NULL;    
  char* dir = argv[1];
  struct stat fileStat;
  struct dirent* fichierLu = NULL; 
  
  rep = opendir(dir);
   
  if (rep == NULL) /* Si le dossier n'a pas pu Ãªtre ouvert */
        exit(1); /* (mauvais chemin p ar exemple) */

  while ((fichierLu = readdir(rep)) != NULL){

  
    if ( (stat(fichierLu->d_name, &fileStat) == -1)) {
        perror(strerror(errno));
        exit(EXIT_FAILURE);
    }
    
    if(fichierLu->d_name[0] != '.'){
      displayFileName(fichierLu);
      displayFileRights(fileStat);
      displayFileHolder(fileStat);
      displayFileGroup(fileStat);
      displayFileSize(fileStat);
      displayFileLastModifiedDate(fileStat); 
    }  
  } 


  if (closedir(rep) == -1)
      exit(-1);

  return EXIT_SUCCESS;
}
